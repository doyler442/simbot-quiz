<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Digital Footprint & Future</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- HTML to Canvas Library for downloading the card as an image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- General Body and Layout Fixes --- */
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: auto;
            padding: 2rem 1rem;
        }
        .app-container {
            background-color: rgba(18, 25, 33, 0.9);
            border-radius: 2rem;
            box-shadow: 0 0 30px rgba(100, 255, 218, 0.2);
            max-width: 800px;
            width: 100%;
            height: 90vh;
            max-height: 700px;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            position: relative;
            overflow-y: auto;
            transform: scale(1);
            transition: all 0.3s ease-in-out;
        }
        /* Custom scrollbar for a more thematic feel */
        .app-container::-webkit-scrollbar {
            width: 8px;
        }
        .app-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .app-container::-webkit-scrollbar-thumb {
            background-color: #64ffda;
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .app-container:hover {
            box-shadow: 0 0 40px rgba(100, 255, 218, 0.4);
        }
        .screen {
            display: none;
            width: 100%;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .screen.active {
            display: flex;
        }
        /* Welcome screen needs to be centered */
        #welcomeScreen, #processingScreen {
            justify-content: center;
            padding-top: 0;
            padding-bottom: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Component Styles (Unchanged) --- */
        .button-primary {
            background: #000;
            color: #64ffda;
            padding: 1rem 2.5rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 1.25rem;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
            transition: all 0.3s ease;
            border: 2px solid #64ffda;
            cursor: pointer;
            margin-top: 2rem;
        }
        .button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
            background: rgba(100, 255, 218, 0.1);
        }
        .button-option {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 1.5rem;
            font-weight: 500;
            font-size: 1rem;
            box-shadow: 0 0 5px rgba(100, 255, 218, 0.2);
            transition: all 0.2s ease;
            border: 1px solid rgba(100, 255, 218, 0.5);
            cursor: pointer;
            margin: 0.5rem;
            min-width: 200px;
            text-align: center;
        }
        .button-option:hover {
            background-color: rgba(100, 255, 218, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.8);
        }
        .button-option.selected {
            background: rgba(100, 255, 218, 0.15);
            color: #64ffda;
            border-color: #64ffda;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.8);
        }
        .question-text {
            font-size: 2rem;
            font-weight: 700;
            color: #e0e7ff;
            margin-bottom: 2.5rem;
            line-height: 1.3;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #64ffda;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .results-section h2 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #e0e7ff;
            margin-bottom: 1.5rem;
        }
        .results-section p {
            font-size: 1.25rem;
            color: #ccc;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .results-section #digitalSnapshot,
        .results-section #futureDigitalTip {
            font-weight: 600;
            color: #64ffda;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(100, 255, 218, 0.5);
            transition: all 0.5s ease-in-out;
        }

        /* --- Card Design Styles (Unchanged) --- */
        #printableArea {
            width: 100%;
            max-width: 450px;
            background-color: #0d1117;
            border-radius: 2rem;
            padding: 2.5rem 1.5rem;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.2), inset 0 0 10px rgba(100, 255, 218, 0.1);
            min-height: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            position: relative;
            z-index: 10;
        }
        #printableArea::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(0deg, transparent 24%, rgba(100, 255, 218, 0.05) 25%, rgba(100, 255, 218, 0.05) 26%, transparent 27%, transparent 74%, rgba(100, 255, 218, 0.05) 75%, rgba(100, 255, 218, 0.05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(100, 255, 218, 0.05) 25%, rgba(100, 255, 218, 0.05) 26%, transparent 27%, transparent 74%, rgba(100, 255, 218, 0.05) 75%, rgba(100, 255, 218, 0.05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: scanline 10s linear infinite;
            z-index: -1;
        }
        @keyframes scanline {
            0% { background-position: 0 0; }
            100% { background-position: 0 500px; }
        }
        #printableArea .info101-brand {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.8em;
            font-weight: 800;
            text-transform: uppercase;
            line-height: 1.1;
            margin-bottom: 1rem;
            color: #64ffda;
            text-shadow: 0 0 5px #64ffda;
            animation: neon-flicker 1.5s infinite alternate;
            display: inline-block;
        }
        @keyframes neon-flicker {
            0% { opacity: 1; text-shadow: 0 0 5px #64ffda; }
            50% { opacity: 0.8; text-shadow: 0 0 10px #64ffda; }
            100% { opacity: 1; text-shadow: 0 0 5px #64ffda; }
        }
        #digitalAvatar {
            width: 128px;
            height: 128px;
            border-radius: 50%;
            object-fit: cover;
            border: none;
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.8);
            margin: 0.5rem auto 1.5rem auto;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }
        #digitalAvatar:hover {
            box-shadow: 0 0 25px rgba(100, 255, 218, 1);
        }
        #printableArea .section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #64ffda;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 3px #64ffda;
        }
        #printableArea .section-content {
            font-size: 0.9em;
            line-height: 1.4;
            color: #e0e7ff;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-weight: 500;
            padding: 0.5rem;
        }
        .card-section {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #64ffda;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            width: 90%;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.4), inset 0 0 5px rgba(100, 255, 218, 0.2);
            backdrop-filter: blur(5px);
        }
        .card-footer {
            margin-top: 1.5rem; /* Added margin to push it down slightly */
            text-align: center;
        }
        
        /* --- UPDATED: Share Button Styles --- */
        .share-container {
            background-color: rgba(10, 15, 20, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid #64ffda;
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            max-width: 450px;
        }
        .share-container p {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-align: center;
            line-height: 1.5;
        }
        .share-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.2s ease;
            border: 1px solid rgba(100, 255, 218, 0.5);
            cursor: pointer;
            text-decoration: none;
        }
        .share-button:hover {
            background-color: rgba(100, 255, 218, 0.1);
            transform: translateY(-2px);
            color: #64ffda;
        }
        .share-button svg {
            width: 24px;
            height: 24px;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
            }
            .app-container {
                padding: 1.5rem;
                border-radius: 1.5rem;
                height: auto;
                max-height: none;
            }
            .question-text {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .button-option {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                margin: 0.3rem;
                min-width: unset;
                width: 100%;
            }
            .button-primary {
                padding: 0.8rem 2rem;
                font-size: 1rem;
                margin-top: 1.5rem;
            }
            .results-section h2 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            .results-section p {
                font-size: 1rem;
                margin-bottom: 0.8rem;
            }
            .results-section #digitalSnapshot,
            .results-section #futureDigitalTip {
                padding: 0.8rem 1rem;
                margin-bottom: 1rem;
            }
            
            #printableArea {
                padding: 1.5rem 1rem;
                min-height: unset;
            }

            #printableArea .info101-brand {
                font-size: 1.2em;
                margin-bottom: 0.75rem;
            }

            #digitalAvatar {
                width: 96px;
                height: 96px;
                margin-top: 0.25rem;
                margin-bottom: 1rem;
            }

            #printableArea .section-title {
                font-size: 1em;
            }

            #printableArea .section-content {
                font-size: 0.8em;
            }

            .card-section {
                padding: 0.75rem;
                width: 100%;
            }
        }
    </style>
    <!-- We're adding a new cyberpunk-style font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app" class="app-container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <svg class="mb-8" width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="15" y="15" width="70" height="70" fill="#121921" stroke="#64ffda" stroke-width="3"/>
                <path d="M30 35H70V65H30V35Z" fill="#121921" stroke="#64ffda" stroke-width="3"/>
                <path d="M45 45L45 55L55 55L55 45L45 45Z" fill="#64ffda" stroke="#64ffda" stroke-width="2">
                    <animate attributeName="fill" values="#64ffda; #121921; #64ffda" dur="2s" repeatCount="indefinite"/>
                </path>
                <path d="M25 40L25 60" stroke="#64ffda" stroke-width="2" stroke-linecap="round"/>
                <path d="M75 40L75 60" stroke="#64ffda" stroke-width="2" stroke-linecap="round"/>
                <path d="M40 85L60 85" stroke="#64ffda" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h1 class="text-5xl font-extrabold text-white mb-4 leading-tight" style="text-shadow: 0 0 10px rgba(100, 255, 218, 0.8);">
                Your Digital Blueprint
            </h1>
            <button id="startButton" class="button-primary">
                Let Frankie the SIMbot draw the plans. Click to begin.
            </button>
        </div>

        <!-- Question Screen -->
        <div id="questionScreen" class="screen">
            <p id="questionText" class="question-text"></p>
            <div id="optionsContainer" class="flex flex-wrap justify-center gap-4 mt-6">
                <!-- Options will be injected here by JavaScript -->
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                <button id="backButton" class="button-primary opacity-50 cursor-not-allowed" disabled>
                    Back
                </button>
                <button id="nextButton" class="button-primary opacity-50 cursor-not-allowed" disabled>
                    Next
                </button>
            </div>
        </div>

        <!-- Processing Screen -->
        <div id="processingScreen" class="screen">
            <div class="loading-spinner"></div>
            <p class="text-2xl font-semibold text-gray-200">Frankie the SIMbot is creating your personalised insights...</p>
            <p class="text-lg text-gray-400 mt-2">Analysing your digital DNA with ✨AI✨.</p>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen results-section">
            <div class="w-full flex flex-col items-center">
                <div id="printableArea"> <!-- Container for the digital card content -->
                    <div class="card-header">
                        <h1 class="info101-brand">
                            BE THE ARCHITECT OF<br/>
                            YOUR DIGITAL LIFE
                        </h1>
                    </div>
                    <img id="digitalAvatar" src="https://placehold.co/96x96/aabbcc/ffffff?text=Avatar" alt="Your Digital Avatar">
                    <div class="card-section">
                        <h2 class="section-title">Your Digital Snapshot!</h2>
                        <p id="digitalSnapshot" class="section-content"></p>
                    </div>
                    <div class="card-section">
                        <h2 class="section-title">Your Future Digital Tip!</h2>
                        <p id="futureDigitalTip" class="section-content"></p>
                    </div>
                    <div class="card-footer">
                        <!-- QR Code Element Removed -->
                    </div>
                </div>
                <!-- UPDATED: Separated Download and Share buttons -->
                <div class="flex flex-col gap-4 mt-8 mb-8">
                    <button id="downloadButton" class="button-primary">
                        Download Your Card
                    </button>
                    <button id="shareButton" class="button-primary">
                        Share Your Card
                    </button>
                    <button id="moreInfoButton" class="button-primary">
                        Find Out More!
                    </button>
                    <button id="goHomeButton" class="button-primary">
                        Go back to start
                    </button>
                </div>

                <!-- UPDATED: Simplified Share options container -->
                <div id="shareContainer" class="share-container hidden">
                    <p>First, <strong>download your card</strong>. Then post it on Insta or TikTok with our hashtags!</p>
                    <button id="copyHashtagsButton" class="share-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <span id="copyHashtagsText">Copy Hashtags & Text</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const questionScreen = document.getElementById('questionScreen');
        const processingScreen = document.getElementById('processingScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const appContainer = document.getElementById('app');

        const startButton = document.getElementById('startButton');
        const questionTextElement = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const nextButton = document.getElementById('nextButton');
        const backButton = document.getElementById('backButton');
        const digitalSnapshotElement = document.getElementById('digitalSnapshot');
        const futureDigitalTipElement = document.getElementById('futureDigitalTip');
        
        // --- UPDATED Elements ---
        const downloadButton = document.getElementById('downloadButton');
        const shareButton = document.getElementById('shareButton');
        const shareContainer = document.getElementById('shareContainer');
        const copyHashtagsButton = document.getElementById('copyHashtagsButton');
        const copyHashtagsText = document.getElementById('copyHashtagsText');
        // --- END UPDATED Elements ---

        const goHomeButton = document.getElementById('goHomeButton');
        const printableArea = document.getElementById('printableArea');
        const digitalAvatarElement = document.getElementById('digitalAvatar');
        const moreInfoButton = document.getElementById('moreInfoButton');

        let currentQuestionIndex = 0;
        let userAnswers = {}; // Stores { questionId: selectedValue }
        let selectedOptionElement = null; // To keep track of the currently selected option button

        // Define your questions and options
        const questions = [
            {
                id: 'q1',
                questionText: "When you first pick up your phone, what's usually the very first app you open?",
                options: [
                    { text: "Social Media (e.g., Instagram, TikTok)", value: 'social_media' },
                    { text: "Streaming (e.g., YouTube, Netflix)", value: 'streaming' },
                    { text: "Messaging (e.g., WhatsApp, Snapchat)", value: 'messaging' },
                    { text: "News/Information App", value: 'news_info' },
                    { text: "Gaming", value: 'gaming' }
                ],
                info101Themes: ['Module 1: What are the building blocks of my Digital Life?', 'Module 2: What is the technology that underpins my Digital Life?']
            },
            {
                id: 'q2',
                questionText: "You see a fascinating headline online. What's your typical next step before sharing it?",
                options: [
                    { text: "Share it immediately, it looks interesting!", value: 'share_immediately' },
                    { text: "Check if friends have shared it", value: 'check_friends' },
                    { text: "Look for other sources to confirm it", value: 'confirm_sources' },
                    { text: "Scroll past, not sure if it's real", value: 'scroll_past' }
                ],
                info101Themes: ['Module 3: How do I organise my Digital Life?', 'Credibility']
            },
            {
                id: 'q3',
                questionText: "When a streaming service recommends a new show, how do you think it figured out you'd like it?",
                options: [
                    { text: "Magic! It just knows.", value: 'magic' },
                    { text: "It knows what I've watched before", value: 'watched_before' },
                    { text: "My friends like it too", value: 'friends_like' },
                    { text: "I told it my preferences directly", value: 'preferences_told' }
                ],
                info101Themes: ['Module 4: Do my Digital Habits matter?', 'Data Analytics']
            },
            {
                id: 'q4',
                questionText: "If you post a photo online, how much control do you feel you have over who eventually sees it?",
                options: [
                    { text: "Total control, only my friends see it", value: 'total_control' },
                    { text: "Some control, depends on privacy settings", value: 'some_control' },
                    { text: "Not much, once it's out there it's public", value: 'not_much_control' },
                    { text: "I don't really think about it", value: 'dont_think' }
                ],
                info101Themes: ['Module 5: What is my Digital Footprint?', 'Security', 'Privacy', 'Identity', 'Reputation']
            },
            {
                id: 'q5',
                questionText: "You're in an online group chat, and someone posts something that makes you uncomfortable. What's your likely reaction?",
                options: [
                    { text: "Ignore it, it's just online", value: 'ignore_online' },
                    { text: "Leave the chat", value: 'leave_chat' },
                    { text: "Challenge it or report it", value: 'challenge_report' },
                    { text: "Talk about it with friends offline", value: 'talk_offline' }
                ],
                info101Themes: ['Module 6: What are the consequences of my Digital Behaviour?', 'Ethics', 'Online Communities', 'Misinformation']
            }
        ];

        // --- Screen Management Functions ---
        function showScreen(screenToShow) {
            const screens = [welcomeScreen, questionScreen, processingScreen, resultsScreen];
            screens.forEach(screen => {
                if (screen === screenToShow) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
        }

        // --- Question Display and Navigation ---
        function loadQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                questionTextElement.textContent = question.questionText;
                optionsContainer.innerHTML = ''; // Clear previous options
                selectedOptionElement = null; // Reset selected option
                nextButton.disabled = true; // Disable next button until an option is selected
                nextButton.classList.add('opacity-50', 'cursor-not-allowed');

                if (currentQuestionIndex > 0) {
                    backButton.disabled = false;
                    backButton.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    backButton.disabled = true;
                    backButton.classList.add('opacity-50', 'cursor-not-allowed');
                }

                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.classList.add('button-option');
                    button.dataset.value = option.value;
                    button.addEventListener('click', () => selectOption(button, question.id, option.value));
                    optionsContainer.appendChild(button);

                    if (userAnswers[question.id] === option.value) {
                        button.classList.add('selected');
                        selectedOptionElement = button;
                        nextButton.disabled = false;
                        nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
                showScreen(questionScreen);
                
                setTimeout(() => {
                    appContainer.scrollTo({ top: 0, behavior: 'smooth' });
                }, 50);
            } else {
                processAnswers();
            }
        }

        function selectOption(button, questionId, value) {
            if (selectedOptionElement) {
                selectedOptionElement.classList.remove('selected');
            }
            button.classList.add('selected');
            selectedOptionElement = button;

            userAnswers[questionId] = value;
            nextButton.disabled = false;
            nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function goToNextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        // --- Gemini API Integration for Text and Image ---
        async function processAnswers() {
            showScreen(processingScreen);
            const textApiUrl = `https://simbot-api-proxy-584934630915.australia-southeast2.run.app/generate-text`;
            const imageApiUrl = `https://simbot-api-proxy-584934630915.australia-southeast2.run.app/generate-image`;

            // --- Step 1: Generate Text Snapshot and Tip ---
            document.querySelector('#processingScreen p:first-of-type').textContent = "Frankie the SIMbot is creating your personalised insights...";
            document.querySelector('#processingScreen p:last-of-type').textContent = "Analysing your digital DNA with ✨AI✨.";

            // --- UPDATED PROMPT ---
            let textPrompt = `You are Frankie the SIMbot, an expert in Information Systems from SIM, specialising in helping young people understand their digital lives. Your task is to analyse a user's answers about their digital habits and generate a personalised response in JSON format.

**Instructions:**
1.  **Analyse User's Answers:** Carefully review the user's choices provided below.
2.  **Select Most Relevant Theme:** Based on the user's answers, choose the single most relevant question from the "INFO101 Themes" list that would be most helpful for them to explore next.
3.  **Generate 'Digital Snapshot':** Write a concise and encouraging summary (1-2 sentences) of the user's current digital persona based on their answers.
4.  **Generate 'Future Digital Tip':** Create a tip that combines two parts. First, it must start *exactly* with the phrase "Frankie thinks you should ask one of the SIM team " followed by the most relevant INFO101 question you selected, enclosed in single quotes. Second, add a full stop right after the closing single quote. Then, add one to two helpful sentences that explain *why* this question is relevant and offer a practical insight.
5.  **Tone & Style:** Your tone must be helpful, encouraging, and knowledgeable. Use New Zealand English spelling and phrasing.

**User Answers:**
`;
            questions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                const selectedOptionText = q.options.find(opt => opt.value === userAnswer)?.text || 'N/A';
                textPrompt += `- ${q.questionText} User chose: "${selectedOptionText}"\n`;
            });

            textPrompt += `
**INFO101 Themes (Choose one for the tip):**
- What are the building blocks of my Digital Life?
- What is the technology that underpins my Digital Life?
- How do I organise my Digital Life?
- Do my Digital Habits matter?
- What is my Digital Footprint?
- What are the consequences of my Digital Behaviour?
- How can I be the Architect of my Digital Life?

**JSON Output Example:**
{
    "snapshot": "It looks like you're thoughtful about what you see online and how you engage with it. That's a great habit for navigating the digital world!",
    "tip": "Frankie thinks you should ask one of the SIM team 'What is my Digital Footprint?'. Being aware of the trail you leave online is the first step to actively shaping your digital reputation."
}
`;

            const textPayload = {
                contents: [{ role: "user", parts: [{ text: textPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "snapshot": { "type": "STRING" },
                            "tip": { "type": "STRING" }
                        },
                        "propertyOrdering": ["snapshot", "tip"]
                    }
                }
            };

            let snapshotText = "Could not generate snapshot.";
            let tipText = "Could not generate tip.";
            let imagePrompt = "";

            try {
                const textResponse = await fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(textPayload)
                });

                if (!textResponse.ok) {
                    const errorDetails = await textResponse.json();
                    console.error(`Text API Error: ${textResponse.status} - ${errorDetails.error || 'Unknown Error'}`, errorDetails.details);
                    digitalSnapshotElement.textContent = `Error: ${errorDetails.error || 'Text generation failed.'}`;
                    futureDigitalTipElement.textContent = `Details: ${errorDetails.details || 'Check proxy server console.'}`;
                    showScreen(resultsScreen);
                    return;
                }

                const textResult = await textResponse.json();

                if (textResult.candidates && textResult.candidates.length > 0 &&
                    textResult.candidates[0].content && textResult.candidates[0].content.parts &&
                    textResult.candidates[0].content.parts.length > 0) {
                    const jsonString = textResult.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    snapshotText = parsedJson.snapshot;
                    tipText = parsedJson.tip;
                } else {
                    console.error("Unexpected text API response structure:", textResult);
                    snapshotText = "Oops! Frankie the SIMbot couldn't generate your digital snapshot right now.";
                    tipText = "Please try again later. (Text API issue)";
                }
            } catch (error) {
                console.error("Error calling Gemini Text API (via proxy):", error);
                snapshotText = "Network error or proxy issue for text generation.";
                tipText = "Please ensure your local proxy server is running.";
            }

            digitalSnapshotElement.textContent = snapshotText;
            futureDigitalTipElement.textContent = tipText;

            // --- Step 2: Generate Image Avatar ---
            document.querySelector('#processingScreen p:first-of-type').textContent = "Frankie the SIMbot is creating your unique digital avatar...";
            document.querySelector('#processingScreen p:last-of-type').textContent = "Analysing your digital DNA with ✨AI✨.";

            digitalAvatarElement.src = "https://placehold.co/128x128/aabbcc/ffffff?text=Loading...";

            const isHandDrawn = Math.random() < 0.2;
            
            if (isHandDrawn) {
                imagePrompt = `A friendly, whimsical robot head avatar. Style is a simple, black ink line drawing on a white background, like a hand-drawn sketch from a notebook.`;
            } else {
                const materials = ['cardboard boxes', 'recycled metal parts', 'old toys', 'vintage electronics', 'junk from a workshop'];
                const emotions = ['happy', 'curious', 'thoughtful', 'playful'];
                const styles = ['cyberpunk', 'steampunk', 'retro-futuristic'];

                const randomMaterial = materials[Math.floor(Math.random() * materials.length)];
                const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];

                imagePrompt = `A single, unique robot head avatar in a cartoon style. The robot is ${randomEmotion} and looks homemade, constructed from simple, everyday objects like ${randomMaterial}. The style is ${randomStyle} with a vibrant, colorful palette. The background is simple and clean.`;
            }

            if (imagePrompt) {
                const imagePayload = { instances: { prompt: imagePrompt }, parameters: { "sampleCount": 1} };
                try {
                    const imageResponse = await fetch(imageApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(imagePayload)
                    });

                    if (!imageResponse.ok) {
                        console.error(`Image API Error: ${imageResponse.status}`);
                        digitalAvatarElement.src = "https://placehold.co/128x128/ff0000/ffffff?text=API+Error";
                    } else {
                        const imageResult = await imageResponse.json();
                        if (imageResult.predictions && imageResult.predictions.length > 0 && imageResult.predictions[0].bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${imageResult.predictions[0].bytesBase64Encoded}`;
                            digitalAvatarElement.src = imageUrl;
                        } else {
                            console.error("Unexpected image API response structure:", imageResult);
                            digitalAvatarElement.src = "https://placehold.co/128x128/cccccc/333333?text=Error";
                        }
                    }
                } catch (error) {
                    console.error("Error calling Gemini Image API (via proxy):", error);
                    digitalAvatarElement.src = "https://placehold.co/128x128/cccccc/333333?text=Network+Error";
                }
            } else {
                console.warn("Image prompt was empty, skipping image generation.");
                digitalAvatarElement.src = "https://placehold.co/128x128/cccccc/333333?text=No+Avatar";
            }
            
            // --- Final Step: Display Results ---
            showScreen(resultsScreen);
        }

        // --- UPDATED: Share and Download Functionality ---
        
        // This function handles downloading the image
        function downloadCard() {
            html2canvas(printableArea, {
                useCORS: true,
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'MyDigitalFootprintCard.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // --- UPDATED: Simplified share button logic ---
        // This function just shows or hides the share instructions.
        function toggleShareContainer() {
            shareContainer.classList.toggle('hidden');
        }
        
        // Function to copy hashtags and text to clipboard
        function copyHashtags() {
            // --- EDIT THIS LINE TO CHANGE THE TEXT AND HASHTAGS ---
            const textToCopy = 'I just discovered my digital blueprint from Frankie the SIMbot! #FrankietheSIMbot #SIM #WSBGOpenDay2025';
            
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            copyHashtagsText.textContent = 'Copied!';
            setTimeout(() => {
                copyHashtagsText.textContent = 'Copy Hashtags & Text';
            }, 2000);
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            currentQuestionIndex = 0;
            userAnswers = {};
            loadQuestion();
        });

        nextButton.addEventListener('click', goToNextQuestion);
        backButton.addEventListener('click', goToPreviousQuestion);

        // --- UPDATED Event Listeners ---
        downloadButton.addEventListener('click', downloadCard);
        shareButton.addEventListener('click', toggleShareContainer);
        copyHashtagsButton.addEventListener('click', copyHashtags);
        
        goHomeButton.addEventListener('click', () => {
            currentQuestionIndex = 0;
            userAnswers = {};
            selectedOptionElement = null;
            shareContainer.classList.add('hidden'); // Hide share container on reset
            showScreen(welcomeScreen);
        });
        
        moreInfoButton.addEventListener('click', () => {
            const moreInfoLink = 'https://nuku.wgtn.ac.nz/courses/17023/pages/home';
            window.open(moreInfoLink, '_blank');
        });

        // Initial screen load
        showScreen(welcomeScreen);
    </script>
</body>
</html>
